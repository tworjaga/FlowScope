#!/usr/bin/env python3
"""
–¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∑–∞—Ö–≤–∞—Ç–∞ –ø–∞–∫–µ—Ç–æ–≤
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã Npcap –∏ –≤—ã–±–æ—Ä–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
"""

import sys
from scapy.all import sniff, get_if_list, get_if_addr, conf

print("=" * 70)
print("–¢–ï–°–¢ –ó–ê–•–í–ê–¢–ê –ü–ê–ö–ï–¢–û–í - Network Analyzer Pro")
print("=" * 70)
print()

# –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ Scapy
print("‚úì Scapy –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ")
print(f"  –í–µ—Ä—Å–∏—è Scapy: {conf.version}")
print()

# –®–∞–≥ 2: –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤
print("üìã –î–û–°–¢–£–ü–ù–´–ï –ò–ù–¢–ï–†–§–ï–ô–°–´:")
print("-" * 70)

interfaces = []
for i, iface in enumerate(get_if_list(), 1):
    try:
        ip = get_if_addr(iface)
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø
        if 'Loopback' in iface:
            iface_type = "üîÅ Loopback"
            active = False
        elif ip == '0.0.0.0' or ip.startswith('169.254'):
            iface_type = "‚ùå –ù–µ–∞–∫—Ç–∏–≤–Ω—ã–π"
            active = False
        elif 'Wi-Fi' in iface or 'Wireless' in iface or 'WLAN' in iface:
            iface_type = "üì° Wi-Fi"
            active = True
        elif 'Ethernet' in iface or 'eth' in iface.lower():
            iface_type = "üîå Ethernet"
            active = True
        else:
            iface_type = "üåê –î—Ä—É–≥–æ–π"
            active = ip != '0.0.0.0'
        
        print(f"{i}. {iface_type}")
        print(f"   –ò–º—è: {iface}")
        print(f"   IP:  {ip}")
        
        if active:
            print(f"   ‚úÖ –ê–ö–¢–ò–í–ù–´–ô - –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å")
            interfaces.append((i, iface, ip))
        else:
            print(f"   ‚ö†Ô∏è  –ù–µ–∞–∫—Ç–∏–≤–Ω—ã–π - –ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å")
        print()
        
    except Exception as e:
        print(f"{i}. ‚ùå –û—à–∏–±–∫–∞")
        print(f"   –ò–º—è: {iface}")
        print(f"   –û—à–∏–±–∫–∞: {e}")
        print()

# –®–∞–≥ 3: –¢–µ–∫—É—â–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
print("-" * 70)
print(f"üéØ –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: {conf.iface}")
print()

# –®–∞–≥ 4: –í—ã–±–æ—Ä –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –¥–ª—è —Ç–µ—Å—Ç–∞
if not interfaces:
    print("‚ùå –ù–ï–¢ –ê–ö–¢–ò–í–ù–´–• –ò–ù–¢–ï–†–§–ï–ô–°–û–í!")
    print()
    print("–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:")
    print("1. Npcap –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ")
    print("2. –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–µ—Ç–µ–≤–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è")
    print("3. –¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞")
    print()
    print("–†–µ—à–µ–Ω–∏–µ:")
    print("1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Npcap —Å WinPcap API-compatible Mode")
    print("2. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –∫–æ–º–ø—å—é—Ç–µ—Ä")
    print("3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –æ—Ç –∏–º–µ–Ω–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞")
    sys.exit(1)

print("=" * 70)
print("–¢–ï–°–¢ –ó–ê–•–í–ê–¢–ê –ü–ê–ö–ï–¢–û–í")
print("=" * 70)
print()

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
test_num, test_iface, test_ip = interfaces[0]

print(f"–í—ã–±—Ä–∞–Ω –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å #{test_num}:")
print(f"  –ò–º—è: {test_iface}")
print(f"  IP:  {test_ip}")
print()

print("‚è≥ –ù–∞—á–∏–Ω–∞–µ–º –∑–∞—Ö–≤–∞—Ç –ø–∞–∫–µ—Ç–æ–≤...")
print("   –§–∏–ª—å—Ç—Ä: tcp or udp")
print("   –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: 10 –ø–∞–∫–µ—Ç–æ–≤")
print("   –¢–∞–π–º–∞—É—Ç: 30 —Å–µ–∫—É–Ω–¥")
print()
print("üí° –°–û–í–ï–¢: –û—Ç–∫—Ä–æ–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä –∏ –∑–∞–π–¥–∏—Ç–µ –Ω–∞ –ª—é–±–æ–π —Å–∞–π—Ç")
print("          —á—Ç–æ–±—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∞—Ñ–∏–∫")
print()
print("-" * 70)

packet_count = 0

def packet_callback(pkt):
    global packet_count
    packet_count += 1
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–∞–∫–µ—Ç–µ
    summary = pkt.summary()
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–æ—Ç–æ–∫–æ–ª
    if pkt.haslayer('TCP'):
        proto = "TCP"
    elif pkt.haslayer('UDP'):
        proto = "UDP"
    else:
        proto = "OTHER"
    
    print(f"‚úì –ü–∞–∫–µ—Ç #{packet_count} [{proto}]: {summary[:60]}")

try:
    # –ó–∞—Ö–≤–∞—Ç –ø–∞–∫–µ—Ç–æ–≤
    sniff(
        iface=test_iface,
        filter="tcp or udp",
        prn=packet_callback,
        count=10,
        timeout=30
    )
    
    print("-" * 70)
    print()
    
    if packet_count > 0:
        print("‚úÖ –£–°–ü–ï–•! –ó–∞—Ö–≤–∞—á–µ–Ω–æ –ø–∞–∫–µ—Ç–æ–≤:", packet_count)
        print()
        print("–í–∞—à –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ!")
        print(f"–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏: {test_iface}")
        print()
        print("–ò–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –≤ config/settings.yaml:")
        print(f'  default_interface: "{test_iface}"')
    else:
        print("‚ùå –û–®–ò–ë–ö–ê: –ù–µ –∑–∞—Ö–≤–∞—á–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –ø–∞–∫–µ—Ç–∞!")
        print()
        print("–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:")
        print("1. –ß–µ—Ä–µ–∑ —ç—Ç–æ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–µ –∏–¥—ë—Ç —Ç—Ä–∞—Ñ–∏–∫")
        print("2. Npcap —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ")
        print("3. –§–∞–π—Ä–≤–æ–ª –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞—Ö–≤–∞—Ç")
        print("4. –ù—É–∂–Ω—ã –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞")
        print()
        print("–ü–æ–ø—Ä–æ–±—É–π—Ç–µ:")
        print("1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –æ—Ç –∏–º–µ–Ω–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞")
        print("2. –í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ")
        print("3. –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Npcap —Å WinPcap API-compatible Mode")
    
except KeyboardInterrupt:
    print()
    print("‚ö†Ô∏è  –ü—Ä–µ—Ä–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
    print(f"   –ó–∞—Ö–≤–∞—á–µ–Ω–æ –ø–∞–∫–µ—Ç–æ–≤: {packet_count}")
    
except Exception as e:
    print()
    print(f"‚ùå –û–®–ò–ë–ö–ê: {e}")
    print()
    print("–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:")
    print("1. –¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞")
    print("2. Npcap –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
    print("3. –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
    print()
    print("–†–µ—à–µ–Ω–∏–µ:")
    print("1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –æ—Ç –∏–º–µ–Ω–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞")
    print("2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Npcap: https://npcap.com/")
    print("3. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –∫–æ–º–ø—å—é—Ç–µ—Ä")

print()
print("=" * 70)
print("–î–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —Å–º. NPCAP_SETUP_GUIDE.md")
print("=" * 70)
